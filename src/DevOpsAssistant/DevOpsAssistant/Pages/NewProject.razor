@page "/projects/new"
@layout SimpleLayout
@using DevOpsAssistant.Services
@using DevOpsAssistant.Components
@inject DevOpsConfigService ConfigService
@inject NavigationManager NavigationManager
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SettingsDialog> L
@inject IStringLocalizer<GlobalOptionsDialog> TL

<PageTitle>DevOpsAssistant - New Project</PageTitle>

<MudPaper Class="p-4">
    <MudStack Spacing="2">
        <MudText Typo="Typo.h5">@L["NewProject"]</MudText>
        <MudTextField @bind-Value="_name" Label='@L["ProjectName"]' />
        <MudTextField @bind-Value="_organization" Label="DevOps Organization" />
        <MudTextField @bind-Value="_project" Label="DevOps Project" />
        <MudTextField @bind-Value="_patToken" Label="@TL["PatToken"]" InputType="InputType.Password" HelperText="Leave blank to use global token" />
        @if (string.IsNullOrWhiteSpace(ConfigService.GlobalPatToken))
        {
            <MudCheckBox T="bool" @bind-Value="_useAsGlobal" Label="Use as global token" />
        }
        <MudButton OnClick="Create" Variant="Variant.Filled" Color="Color.Primary" Disabled="_name.Trim().Length < 2 || string.IsNullOrWhiteSpace(_organization) || string.IsNullOrWhiteSpace(_project)">@L["Create"]</MudButton>
    </MudStack>
</MudPaper>

@code {
    private string _name = string.Empty;
    private string _organization = string.Empty;
    private string _project = string.Empty;
    private string _patToken = string.Empty;
    private bool _useAsGlobal;

    protected override async Task OnInitializedAsync()
    {
        await ConfigService.LoadAsync();
        if (string.IsNullOrWhiteSpace(ConfigService.GlobalPatToken))
            _useAsGlobal = true;
    }

    private async Task Create()
    {
        await ConfigService.AddProjectAsync(_name);
        await ConfigService.SaveAsync(new DevOpsConfig
        {
            Organization = _organization,
            Project = _project,
            PatToken = _patToken
        });
        if (_useAsGlobal && !string.IsNullOrWhiteSpace(_patToken))
        {
            await ConfigService.SaveGlobalPatAsync(_patToken);
        }
        NavigationManager.NavigateTo($"/projects/{_name}", forceLoad: true);
    }
}
