@page "/work-items"
@using DevOpsAssistant.Services
@inject DevOpsApiService ApiService
@inject DevOpsConfigService ConfigService

<PageTitle>Work Items</PageTitle>

<MudPaper Class="p-4 mb-4">
    <MudGrid>
        <MudItem xs="12" md="4">
            <MudSelect T="string" @bind-Value="_path" Label="Backlog">
                @foreach (var b in _backlogs)
                {
                    <MudSelectItem Value="@b">@b</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudSelect T="string" Label="States" SelectedValues="_selectedStates" SelectedValuesChanged="OnStatesChanged" MultiSelection="true">
                @foreach (var s in _stateOptions)
                {
                    <MudSelectItem Value="@s">@s</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudSelect T="string" Label="Tags" SelectedValues="_selectedTags" SelectedValuesChanged="OnTagsChanged" MultiSelection="true">
                @foreach (var t in _tagOptions)
                {
                    <MudSelectItem Value="@t">@t</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12">
            <MudButton Color="Color.Primary" OnClick="Load">Load</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (_roots != null)
{
    <MudPaper Class="work-item-container">
        <ul class="work-item-tree">
        @foreach (var epic in _roots)
        {
            <li>
                <MudLink Href="@epic.Info.Url" Target="_blank"><b>@epic.Info.Title</b></MudLink> - @epic.Info.WorkItemType (@epic.Info.State)
                @StatusIcon(epic)
                @if (epic.Children.Any())
                {
                    <ul>
                        @foreach (var feature in epic.Children)
                        {
                            <li>
                                <MudLink Href="@feature.Info.Url" Target="_blank"><b>@feature.Info.Title</b></MudLink> - @feature.Info.WorkItemType (@feature.Info.State)
                                @StatusIcon(feature)
                                @if (feature.Children.Any())
                                {
                                    <ul>
                                        @foreach (var item in feature.Children)
                                        {
                                            <li><MudLink Href="@item.Info.Url" Target="_blank">@item.Info.Title</MudLink> - @item.Info.WorkItemType (@item.Info.State)</li>
                                        }
                                    </ul>
                                }
                            </li>
                        }
                    </ul>
                }
            </li>
        }
        </ul>
    </MudPaper>
}

@code {
    private string _path = string.Empty;
    private string[] _backlogs = Array.Empty<string>();
    private string[] _stateOptions = Array.Empty<string>();
    private string[] _tagOptions = Array.Empty<string>();
    private IEnumerable<string> _selectedStates = Array.Empty<string>();
    private IEnumerable<string> _selectedTags = Array.Empty<string>();
    private bool _loading;
    private List<WorkItemNode>? _roots;

    protected override async Task OnInitializedAsync()
    {
        _stateOptions = ConfigService.Config.States.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        _tagOptions = ConfigService.Config.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        _backlogs = await ApiService.GetBacklogsAsync();
        if (_backlogs.Length > 0)
            _path = _backlogs[0];
    }

    private async Task Load()
    {
        _loading = true;
        StateHasChanged();
        try
        {
            var state = _selectedStates.Any() ? string.Join(',', _selectedStates) : null;
            var tags = _selectedTags.Any() ? string.Join(',', _selectedTags) : null;
            _roots = await ApiService.GetWorkItemHierarchyAsync(_path, state, tags);
        }
        finally
        {
            _loading = false;
        }
    }

    private void OnStatesChanged(IEnumerable<string> values) => _selectedStates = values;
    private void OnTagsChanged(IEnumerable<string> values) => _selectedTags = values;

    private RenderFragment StatusIcon(WorkItemNode node) => builder =>
    {
        if (!node.StatusValid)
        {
            builder.OpenComponent<MudIcon>(0);
            builder.AddAttribute(1, "Color", Color.Warning);
            builder.AddAttribute(2, "Icon", Icons.Material.Filled.Warning);
            builder.CloseComponent();
        }
    };
}
