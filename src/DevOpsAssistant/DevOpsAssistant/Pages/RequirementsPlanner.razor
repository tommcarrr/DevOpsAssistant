@page "/requirements-planner"
@using System.Text.Json
@using MudBlazor
@using DevOpsAssistant.Services
@inject DevOpsApiService ApiService
@inject DevOpsConfigService ConfigService
@inject IJSRuntime JS

<PageTitle>Requirement Planner</PageTitle>

<MudAlert Severity="Severity.Info" Class="mb-4">
    Search a wiki page and generate a prompt to break requirements into Epics, Features and User Stories.
    Paste the LLM response below to import items and create them in a backlog.
</MudAlert>
@if (!string.IsNullOrWhiteSpace(_error))
{
    <MudAlert Severity="Severity.Error" Class="mb-4">@_error</MudAlert>
}
<MudPaper Class="p-4 mb-4">
    <MudStack Spacing="2">
        @if (_wikiItems != null)
        {
            <MudTreeView T="WikiPageNode" Items="@_wikiItems" SelectionMode="SelectionMode.MultiSelection" @bind-SelectedValues="_selectedPages" Style="max-height:300px; overflow:auto; width:100%;">
                <ItemTemplate>
                    <MudTreeViewItem Items="@context.Children" Value="@context.Value" Text="@context.Text" @bind-Expanded="@context.Expanded" />
                </ItemTemplate>
            </MudTreeView>
        }
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
            <MudSelect T="string" @bind-Value="_backlog" Label="Backlog">
                @foreach (var b in _backlogs)
                {
                    <MudSelectItem Value="@b">@b</MudSelectItem>
                }
            </MudSelect>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_selectedPages == null || _selectedPages.Count == 0" OnClick="Generate">Generate Prompt</MudButton>
        </MudStack>
    </MudStack>
</MudPaper>
@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (!string.IsNullOrWhiteSpace(_prompt))
{
    <MudPaper Class="pa-2 mb-4">
        <MudStack Spacing="2">
            <MudTextField T="string" Text="@_prompt" Lines="10" ReadOnly="true" Class="w-100" />
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ContentCopy" OnClick="CopyPrompt">Copy</MudButton>
        </MudStack>
    </MudPaper>
    <MudPaper Class="pa-2 mb-4">
        <MudTextField T="string" @bind-Value="_responseText" Lines="6" Label="LLM Response" Class="w-100" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ImportPlan">Import</MudButton>
    </MudPaper>
}
@if (_plan != null)
{
    <MudList T="string" Dense="true" Class="mb-2">
        @foreach (var epic in _plan.Epics)
        {
            <MudListItem T="string">
                <b>Epic:</b> @epic.Title
                <MudText Class="d-block ms-4">@epic.Description</MudText>
                @if (epic.Features.Count > 0)
                {
                    <MudList T="string" Dense="true" Class="ms-4">
                        @foreach (var feature in epic.Features)
                        {
                            <MudListItem T="string">
                                <b>Feature:</b> @feature.Title
                                <MudText Class="d-block ms-4">@feature.Description</MudText>
                                @if (feature.Stories.Count > 0)
                                {
                                    <MudList T="string" Dense="true" Class="ms-4">
                                        @foreach (var story in feature.Stories)
                                        {
                                            <MudListItem T="string">
                                                <b>Story:</b> @story.Title
                                                <MudText Class="d-block ms-4">@story.Description</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }
                            </MudListItem>
                        }
                    </MudList>
                }
            </MudListItem>
        }
    </MudList>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_loading" OnClick="CreateItems">Create Work Items</MudButton>
}

@code {
    private List<TreeItemData<WikiPageNode>>? _wikiItems;
    private IReadOnlyCollection<WikiPageNode>? _selectedPages;
    private string _wikiId = string.Empty;
    private string _prompt = string.Empty;
    private string _responseText = string.Empty;
    private bool _loading;
    private string? _error;
    private string[] _backlogs = [];
    private string _backlog = string.Empty;
    private Plan? _plan;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await ConfigService.LoadAsync();
            _backlogs = await ApiService.GetBacklogsAsync();
            if (_backlogs.Length > 0)
                _backlog = _backlogs[0];

            var wikis = await ApiService.GetWikisAsync();
            if (wikis.Count > 0)
            {
                _wikiId = wikis[0].Id;
                var root = await ApiService.GetWikiPageTreeAsync(_wikiId);
                if (root != null)
                    _wikiItems = [BuildTreeItem(root)];
            }

            _error = null;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task Generate()
    {
        if (_selectedPages == null || _selectedPages.Count == 0) return;
        _loading = true;
        StateHasChanged();
        try
        {
            var pages = new List<(string Name, string Text)>();
            foreach (var p in _selectedPages)
            {
                var text = await ApiService.GetWikiPageContentAsync(_wikiId, p.Path);
                pages.Add((p.Name, text));
            }
            _prompt = BuildPrompt(pages);
            _error = null;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task CopyPrompt()
    {
        if (!string.IsNullOrWhiteSpace(_prompt))
            await JS.InvokeVoidAsync("copyText", _prompt);
    }

    private void ImportPlan()
    {
        try
        {
            var json = ExtractJson(_responseText);
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            _plan = JsonSerializer.Deserialize<Plan>(json, options);
            _error = null;
        }
        catch (Exception ex)
        {
            _plan = null;
            _error = ex.Message;
        }
    }

    private static string ExtractJson(string text)
    {
        var start = text.IndexOf('{');
        var end = text.LastIndexOf('}');
        return start >= 0 && end > start
            ? text[start..(end + 1)]
            : text;
    }

    private async Task CreateItems()
    {
        if (_plan == null) return;
        _loading = true;
        StateHasChanged();
        try
        {
            foreach (var epic in _plan.Epics)
            {
                epic.Id = await ApiService.CreateWorkItemAsync("Epic", epic.Title, epic.Description, _backlog);
                foreach (var feature in epic.Features)
                {
                    feature.Id = await ApiService.CreateWorkItemAsync("Feature", feature.Title, feature.Description, _backlog, epic.Id);
                    foreach (var story in feature.Stories)
                        story.Id = await ApiService.CreateWorkItemAsync("User Story", story.Title, story.Description, _backlog, feature.Id);
                }
            }
            _error = null;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private static TreeItemData<WikiPageNode> BuildTreeItem(WikiPageNode node)
    {
        var item = new TreeItemData<WikiPageNode> { Value = node, Text = node.Name };
        if (node.Children.Count > 0)
            item.Children = node.Children.Select(BuildTreeItem).ToList();
        return item;
    }

    private static string BuildPrompt(IEnumerable<(string Name, string Text)> pages)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("You are a business analyst. Break down the following requirements into Epics, Features and User Stories.");
        sb.AppendLine("Return JSON in this format:\n{\"epics\":[{\"title\":\"\",\"description\":\"\",\"features\":[{\"title\":\"\",\"description\":\"\",\"stories\":[{\"title\":\"\",\"description\":\"\"}]}]}]}");
        sb.AppendLine();
        sb.AppendLine("Document:");
        foreach (var page in pages)
        {
            sb.AppendLine($"## {page.Name}");
            sb.AppendLine(page.Text);
            sb.AppendLine();
        }
        return sb.ToString();
    }

    private class Plan
    {
        public List<Epic> Epics { get; set; } = new();
    }

    private class Epic
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public List<Feature> Features { get; set; } = new();
    }

    private class Feature
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public List<Story> Stories { get; set; } = new();
    }

    private class Story
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }
}
