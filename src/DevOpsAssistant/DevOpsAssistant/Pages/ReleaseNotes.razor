@page "/release-notes"
@using System.Text
@using System.Text.Json
@inject DevOpsApiService ApiService
@inject IJSRuntime JS

<PageTitle>Release Notes Prompt</PageTitle>

<MudAlert Severity="Severity.Info" Class="mb-4">
    Search and select user stories, then click <b>Generate</b> to build a
    prompt summarizing them for release notes. Use the copy button to
    copy the generated text to the clipboard.
</MudAlert>

<MudPaper Class="p-4 mb-4">
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.End" Wrap="Wrap.Wrap">
        <MudAutocomplete T="WorkItemInfo"
                         Label="User Stories"
                         SearchFunc="SearchStories"
                         ToStringFunc="@(s => $"{s.Id} - {s.Title}")"
                         Value="_searchValue"
                         ValueChanged="OnStorySelected"/>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_loading" OnClick="Generate">Generate Prompt</MudButton>
    </MudStack>
</MudPaper>

@if (_selectedStories.Any())
{
    <MudTable Items="_selectedStories" Dense="true" Class="mb-4">
        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Title</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="ID">@context.Id</MudTd>
            <MudTd DataLabel="Title">@context.Title</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               Size="Size.Small"
                               OnClick="() => Remove(context)"/>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
}
else if (!string.IsNullOrWhiteSpace(_prompt))
{
    <MudPaper Class="pa-2">
        <MudStack Spacing="2">
            <MudTextField T="string"
                          Text="@_prompt"
                          Lines="10"
                          ReadOnly="true"
                          Class="w-100" />
            <MudButton Variant="Variant.Text"
                       StartIcon="@Icons.Material.Filled.ContentCopy"
                       OnClick="CopyPrompt">
                Copy
            </MudButton>
        </MudStack>
    </MudPaper>
}

@code {
    private readonly HashSet<WorkItemInfo> _selectedStories = [];
    private WorkItemInfo? _searchValue;
    private bool _loading;
    private string? _prompt;

    private Task<IEnumerable<WorkItemInfo>> SearchStories(string value, CancellationToken _)
    {
        if (string.IsNullOrWhiteSpace(value) || value.Length < 2)
            return Task.FromResult<IEnumerable<WorkItemInfo>>(Array.Empty<WorkItemInfo>());
        return ApiService.SearchUserStoriesAsync(value).ContinueWith(t => (IEnumerable<WorkItemInfo>)t.Result);
    }

    private void OnStorySelected(WorkItemInfo? item)
    {
        if (item != null)
            _selectedStories.Add(item);
        _searchValue = null;
        StateHasChanged();
    }

    private void Remove(WorkItemInfo story)
    {
        _selectedStories.Remove(story);
        StateHasChanged();
    }

    private async Task Generate()
    {
        if (_selectedStories.Count == 0) return;
        _loading = true;
        StateHasChanged();
        try
        {
            var ids = _selectedStories.Select(s => s.Id);
            var details = await ApiService.GetStoryHierarchyDetailsAsync(ids);
            _prompt = BuildPrompt(details);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task CopyPrompt()
    {
        if (!string.IsNullOrWhiteSpace(_prompt))
            await JS.InvokeVoidAsync("copyText", _prompt);
    }

    private static string BuildPrompt(IEnumerable<StoryHierarchyDetails> details)
    {
        var hierarchy = details.Select(d => new
        {
            Epic = d.Epic == null ? null : new { d.Epic.Id, d.Epic.Title },
            Feature = d.Feature == null ? null : new { d.Feature.Id, d.Feature.Title },
            Story = new { d.Story.Id, d.Story.Title, d.Description }
        });

        var json = JsonSerializer.Serialize(
            hierarchy,
            new JsonSerializerOptions { WriteIndented = true });

        var sb = new StringBuilder();

        sb.AppendLine("Generate a Word document containing release notes and change control details based on the following work item hierarchy.");
        sb.AppendLine();
        sb.AppendLine("For the release notes, include:");
        sb.AppendLine("- A high-level summary in plain, non-technical language.");
        sb.AppendLine("- Group stories under their related features and epics.");
        sb.AppendLine("- For each story, write a short summary in non-technical language that explains the purpose and value of the change in a way that would make sense to a general audience at a software company.");
        sb.AppendLine("  Do not copy or paraphrase the story description. Use context from the feature and epic to help explain the storyâ€™s intent and benefit.");
        sb.AppendLine();
        sb.AppendLine("For the change control details, include:");
        sb.AppendLine("- A high-level summary in plain language for all stories aggregated into one or two paragraphs as appropriate..");
        sb.AppendLine("- A list of all stories with their IDs and titles.");
        sb.AppendLine("- A section highlighting any potential risks.");
        sb.AppendLine();
        sb.AppendLine("Please return the result as a downloadable Word document.");

        sb.AppendLine();
        sb.AppendLine("Work items:");
        sb.AppendLine(json);
        return sb.ToString();
    }

}