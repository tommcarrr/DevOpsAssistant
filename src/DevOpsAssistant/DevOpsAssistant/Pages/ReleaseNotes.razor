@page "/projects/{ProjectName}/release-notes"
@using System.Text
@using System.Text.Json
@using System.Text.Json.Serialization
@using DevOpsAssistant.Services
@using DevOpsAssistant.Services.Models
@using DevOpsAssistant.Utils
@using MudBlazor
@inject DevOpsApiService ApiService
@inject IJSRuntime JS
@inherits ProjectComponentBase
@inject ISnackbar Snackbar
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<ReleaseNotes> L

<PageTitle>DevOpsAssistant - Release Notes</PageTitle>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <MudAlert Severity="Severity.Error">@_error</MudAlert>
}

<WorkItemSelector Expanded="@_filtersExpanded" ExpandedChanged="@(v => _filtersExpanded = v)" UseIteration="true" SelectedChanged="OnWorkItemsSelected" StateKey="StateKey" />
<MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_loading || !_selectedItems.Any()" OnClick="Generate">Generate Prompt</MudButton>
@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
}
else if (_promptParts != null)
{
    <MudPaper Class="pa-6">
        <MudStack Spacing="2">
            <MudButton Variant="Variant.Text"
                       StartIcon="@Icons.Material.Filled.Download"
                       OnClick="DownloadPrompt">
                Download
            </MudButton>
            <MudTextField T="string"
                          Text="@_promptParts[_partIndex]"
                          Lines="10"
                          ReadOnly="true"
                          />
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                <MudTooltip Text='@L["PrevPartTooltip"]'>
                    <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                                   Disabled="_partIndex == 0"
                                   OnClick="PrevPart" />
                </MudTooltip>
                <MudText Typo="Typo.body2">@($"Part {_partIndex + 1}/{_promptParts.Count}")</MudText>
                <MudTooltip Text='@L["NextPartTooltip"]'>
                    <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                                   Disabled="_partIndex == _promptParts.Count - 1"
                                   OnClick="NextPart" />
                </MudTooltip>
                <MudButton Variant="Variant.Text"
                           StartIcon="@Icons.Material.Filled.ContentCopy"
                           OnClick="() => CopyPart(_promptParts[_partIndex])">
                    Copy
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
}

@code {
    [Parameter] public string ProjectName { get; set; } = string.Empty;
    private readonly HashSet<WorkItemInfo> _selectedItems = [];
    private bool _loading;
    private string? _prompt;
    private List<string>? _promptParts;
    private int _partIndex;
    private string? _error;
    private bool _filtersExpanded = true;
    private const string StateKey = "release-notes";

    protected override async Task OnInitializedAsync()
    {
        await ConfigService.LoadAsync();
        if (!string.IsNullOrWhiteSpace(ProjectName) &&
            ConfigService.CurrentProject.Name != ProjectName)
        {
            await ConfigService.SelectProjectAsync(ProjectName);
        }
    }

    private async Task Generate()
    {
        if (_selectedItems.Count == 0) return;
        _filtersExpanded = false;
        _loading = true;
        StateHasChanged();
        try
        {
            var ids = _selectedItems.Select(s => s.Id);
            var details = await ApiService.GetStoryHierarchyDetailsAsync(ids);
            _prompt = BuildPrompt(details, ConfigService.Config);
            _promptParts = PromptHelpers.SplitPrompt(_prompt, ConfigService.Config.PromptCharacterLimit).ToList();
            _partIndex = 0;
            _error = null;
            await CopyPrompt();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }


    private async Task CopyPrompt()
    {
        if (!string.IsNullOrWhiteSpace(_prompt))
        {
            await JS.InvokeVoidAsync("copyText", _prompt);
            Snackbar.Add(L["CopyToast"].Value, Severity.Success);
        }
    }

    private async Task CopyPart(string text)
    {
        await JS.InvokeVoidAsync("copyText", text);
        Snackbar.Add(L["CopyToast"].Value, Severity.Success);
    }

    private void PrevPart()
    {
        if (_partIndex > 0)
            _partIndex--;
    }

    private void NextPart()
    {
        if (_promptParts != null && _partIndex < _promptParts.Count - 1)
            _partIndex++;
    }

    private async Task DownloadPrompt()
    {
        if (!string.IsNullOrWhiteSpace(_prompt))
            await JS.InvokeVoidAsync("downloadText", "prompt.txt", _prompt);
    }



    private Task OnWorkItemsSelected(IReadOnlyCollection<WorkItemInfo> items)
    {
        _selectedItems.Clear();
        foreach (var i in items)
            _selectedItems.Add(i);
        return Task.CompletedTask;
    }


    private static string BuildPrompt(IEnumerable<StoryHierarchyDetails> details, DevOpsConfig config)
    {
        var hierarchy = details.Select(d => new
        {
            Epic = d.Epic == null
                ? null
                : new
                {
                    d.Epic.Id,
                    d.Epic.Title,
                    Description = TextHelpers.Sanitize(d.EpicDescription)
                },
            Feature = d.Feature == null
                ? null
                : new
                {
                    d.Feature.Id,
                    d.Feature.Title,
                    Description = TextHelpers.Sanitize(d.FeatureDescription)
                },
            Item = new
            {
                d.Story.Id,
                d.Story.Title,
                d.Story.WorkItemType,
                Description = TextHelpers.Sanitize(d.Description),
                ReproSteps = config.Rules.Bug.IncludeReproSteps ? TextHelpers.Sanitize(d.ReproSteps) : null,
                SystemInfo = config.Rules.Bug.IncludeSystemInfo ? TextHelpers.Sanitize(d.SystemInfo) : null,
                AcceptanceCriteria = TextHelpers.Sanitize(d.AcceptanceCriteria)
            }
        });

        var json = JsonSerializer.Serialize(
            hierarchy,
            new JsonSerializerOptions
            {
                WriteIndented = true,
                DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
            });

        var sb = new StringBuilder();

        if (string.IsNullOrWhiteSpace(config.ReleaseNotesPrompt))
        {
            sb.AppendLine("You are a meticulous Delivery Manager preparing release notes for a software update.");
            sb.AppendLine("Write in clear, plain language so non-technical stakeholders can understand the changes.");
            sb.AppendLine();
            sb.AppendLine("Document sections:");
            sb.AppendLine("- Release Notes: a high-level summary of all stories in 1â€“2 paragraphs.");
            sb.AppendLine("- Change Control: a short summary, list of stories, and potential risks.");
            sb.AppendLine("- No branding is required.");
            sb.AppendLine();
            sb.AppendLine("Guidelines:");
            sb.AppendLine("- Group stories under their respective Features and Epics.");
            sb.AppendLine("- Bugs are also in scope and may not have a Feature.");
            sb.AppendLine("- For each story write a new summary in plain, non-technical language.");
            sb.AppendLine("- Do NOT copy or paraphrase the original description.");
            sb.AppendLine("- Use clear headings for each Epic, Feature, and Story.");
            sb.AppendLine("- Use bullet points or paragraphs for readability.");
        }
        else
        {
            sb.AppendLine(config.ReleaseNotesPrompt.Trim());
        }

        sb.AppendLine();
        sb.AppendLine("Work items:");

        sb.AppendLine(json);
        sb.AppendLine();
        if (config.OutputFormat == OutputFormat.Inline)
            sb.AppendLine("Reply inline with the final notes.");
        else
            sb.AppendLine($"After generating the notes, convert the content to {config.OutputFormat} format and include that version.");
        return sb.ToString();
    }

    protected override Task OnProjectChangedAsync()
    {
        return OnInitializedAsync();
    }

}
